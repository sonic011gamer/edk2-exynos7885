Attempt to create a minimal EDK2 for Exynos 7885 devices

## Status
Boots to UEFI Shell.

## Tutorials

### Building
Tested on Ubuntu 22.04.

First, clone EDK2.

```
cd ..
git clone https://github.com/tianocore/edk2.git --recursive
git clone https://github.com/tianocore/edk2-platforms.git
```

You should have all three directories side by side.

Next, install dependencies:

18.04:

```
sudo apt install build-essential uuid-dev iasl git nasm python3-distutils gcc-aarch64-linux-gnu
```

Also see [EDK2 website](https://github.com/tianocore/tianocore.github.io/wiki/Using-EDK-II-with-Native-GCC#Install_required_software_from_apt)

First mkdir workspace

Then ./firstrun.sh

Finally, ./build.sh.

Then flash in AP slot in ODIN.

## Porting this project to other Exynos SOCs

> [!NOTE]
> This may get you to somewhat boot EDK2, but it may not reach shell at all and may crash.

### What you will need

- A phone with an Exynos SOC
- ADB Access
- Access to TWRP
- Android Image Kitchen
- Device Tree Compiler
- Your phones screen resolution 

### Grabbing files off your phone

First, we will grab your boot image as in some cases the boot.img generated by the build system won't boot.

To do this, in TWRP do the following command

```adb shell "dd if=/dev/block/by-name/boot of=/tmp/boot.img```

Now grab the file onto your PC

```adb pull /tmp/boot.img```

We also need the information about your phones memory allocations so we can find where to write stuff, like enabling framebuffer.

To get it, in TWRP do the following commands

```adb shell```

```cat /proc/iomem>>/tmp/iomem.txt```

Now grab the iomem

```adb pull /tmp/iomem.txt```

Finally we need your phones DTB (Device Tree Blob)

To get it, do the following command in TWRP

```adb shell "cat /sys/firmware/fdt>>/tmp/fdt```

Now grab the DTB

```adb pull /tmp/fdt```

###  Taking notes of what is needed

First we will need the memory base, to find it open up the iomem you dumped and look for the "System RAM" segment, specifically the first one that comes up, We will assume ```80000000-baafffff : System RAM``` as an example. You want to take note of the first part, which in this case is 80000000.

Next we need the decon area, this is needed for framebuffer, in the iomem dump look for the "decon_f" segment, We will assume ```19050000-1905ffff : decon_f@0x19050000``` to be decon as an example, just as before take note of the first part, which in this case is 19050000

Now we're gonna decompile your DTB into a DTS (Device Tree Source), to do this do the following command ```dtc -I dtb -O dts -o devicetree.dts fdt```

Now open devicetree.dts in a Text Editor, we're gonna look for the interrupt-controller node, again we will assume the interrupt-controller here to be

```
  interrupt-controller@10100000 {
    compatible = "arm,cortex-a15-gic\0arm,cortex-a9-gic";
    #interrupt-cells = <0x03>;
    #address-cells = <0x00>;
    interrupt-controller;
    reg = <0x00 0x10101000 0x1000 0x00 0x10102000 0x1000 0x00 0x10104000 0x2000 0x00 0x10106000 0x2000>;
    interrupts = <0x01 0x09 0xf04>;
    phandle = <0x01>;
  };
```

You want to take notes of 2 numbers, the first one being after the "interrupt-controller@", which in this case is 10100000, and the second one being after "reg = <reg 0x00 firstnum 0x1000 0x00" which in this case is 10102000.

The final thing to look for is your bootloader framebuffer address, to find this do the following command while your device is in TWRP ```cat /proc/cmdline``` and look for "s3cfb.bootloaderfb=" or anything along the lines of that, as an example we will assume ```s3cfb.bootloaderfb=0xf1000000```, take note of the offset after the "=", which in this case is 0xf1000000.

Now you can proceed.

### Making the DSC File

> [!NOTE]
> You shouldn't make the device use all the ram yet as it may not boot, stick eith 1.5GB or smaller to be safe.

Go into EXYNOS7885Pkg/Devices and copy a10.dsc to (devicename).dsc, for example we'll copy a10.dsc into s20.dsc

Now theres only a couple things to edit here thankfully.

First thing to edit is "gArmTokenSpaceGuid.PcdSystemMemoryBase|0x80000000", replace "0x80000000" with 0x(Number of the memory base you noted down earlier)

Final things to edit is the framebuffer area, to avoid boring you with more text ill just put the things needing to be edited.

```gEXYNOS7885PkgTokenSpaceGuid.PcdMipiFrameBufferAddress|(Framebuffer offset from earlier)```
  ```gEXYNOS7885PkgTokenSpaceGuid.PcdMipiFrameBufferWidth|(Screen resolution width)```
  ```gEXYNOS7885PkgTokenSpaceGuid.PcdMipiFrameBufferHeight|(Screen resolution height)```
  ```gEXYNOS7885PkgTokenSpaceGuid.PcdMipiFrameBufferVisibleWidth|(Screen resolution width)```
  ```gEXYNOS7885PkgTokenSpaceGuid.PcdMipiFrameBufferVisibleHeight|(Screen resolution height)```

After you've edited that you can save the file and close it.

### Correcting the interrupt controller addresses

Open up EXYNOS7885Pkg/EXYNOS7885.dsc and go to line 115, Replace "gArmTokenSpaceGuid.PcdGicDistributorBase|0x12301000" with "gArmTokenSpaceGuid.PcdGicDistributorBase|0x(First interrupt number you noted)" and then replace "gArmTokenSpaceGuid.PcdGicInterruptInterfaceBase|0x12302000" with "gArmTokenSpaceGuid.PcdGicInterruptInterfaceBase|0x(Second interrupt number you noted)"

You can now save and close the file

### Correcting decon address

Go to https://godbolt.org/ and before doing anything chabge the compiler on the right to ARM64 GCC Trunk.

Then in the left paste

```
void soc_init(void) {
	*(int*) (0x(Decon_F noted from before) + 0x70) = 0x1281;
}
```

On the right is the assemply you want to use but make sure u replace "soc_init():" with "enableDecon:"


Go to EXYNOS7885Pkg/Library
/EXYNOS7885PkgLib and open up "EXYNOS7885PkgHelper.S"

Replace the "enableDecon:" function with the one you got from the online compiler then close and save the file.

### Editing the build script

Open build.sh

Replace any mention of a10.dsc with (Device name).dsc

Now you can build with the steps above.

### Running EDK2 in your device

After your device builds don't use the boot.img in workspace as the bootloader may not like it, Instead take the boot.img you dumped earlier and place it into Android Image Kitchen, unpack it with ```./unpackimg.sh boot.img``` then take the "UEFI" file from the workspace folder and put it into split_image under the name "boot.img-kernel", obviously replacing the old one, repack the image with ```./repackimg.sh```

You can now flash image-new.img onto your phone using whatever you want!


# Credits

SimpleFbDxe screen driver is from imbushuo's [Lumia950XLPkg](https://github.com/WOA-Project/Lumia950XLPkg).

Zhuowei for making edk2-pixel3

all my friends for supporting me (yes also mis012 :)
